"use strict";(self.webpackChunkalgle=self.webpackChunkalgle||[]).push([[158],{777:(t,e,i)=>{i.r(e),i.d(e,{Cube3D:()=>$,PG3D:()=>dt,T3I:()=>w,Twisty3DScene:()=>pt,cube3DShim:()=>ft,pg3dShim:()=>kt});var s,o,r,n,a=i(790),l=i(149),c=i(558),h=i(458),d=i(562),u=i(705),p=i(65),f=i(158),k=i(441),m=(i(268),i(686)),w=i(408);function S(t){return t*t*t*(10-t*(15-6*t))}var v=new w.TextureLoader,M=new w.MeshBasicMaterial({color:new w.Color(6710886).convertLinearToSRGB()}),y=new w.MeshBasicMaterial({color:new w.Color(13421772).convertLinearToSRGB(),side:w.BackSide,transparent:!0,opacity:.75}),A=new w.MeshBasicMaterial({visible:!1}),D=new w.MeshBasicMaterial({color:4513228}),g=new w.MeshBasicMaterial({color:16776618}),x=new w.MeshBasicMaterial({color:4513228,side:w.BackSide,transparent:!0,opacity:.5}),b=new w.MeshBasicMaterial({color:16775545,side:w.BackSide,transparent:!0,opacity:.5}),E=class{constructor(t,e,i,s,o,r){var n,a;(0,u.A)(this,"stickerMaterial",void 0),(0,u.A)(this,"hintStickerMaterial",void 0),this.vector=t,this.fromZ=e,this.color=i,this.dimColor=s,this.hintOpacityScale=o;const l=new w.Color(i).convertLinearToSRGB(),c=new w.Color(s).convertLinearToSRGB();this.stickerMaterial={regular:new w.MeshBasicMaterial({color:l,side:w.FrontSide}),dim:new w.MeshBasicMaterial({color:c,side:w.FrontSide}),oriented:D,experimentalOriented2:g,ignored:M,invisible:A},this.hintStickerMaterial={regular:new w.MeshBasicMaterial({color:new w.Color(null!==(n=null===r||void 0===r?void 0:r.hintColor)&&void 0!==n?n:i).convertLinearToSRGB(),side:w.BackSide,transparent:!0,opacity:.5*o}),dim:new w.MeshBasicMaterial({color:new w.Color(null!==(a=null===r||void 0===r?void 0:r.hintDimColor)&&void 0!==a?a:s).convertLinearToSRGB(),side:w.BackSide,transparent:!0,opacity:.5*o}),oriented:x,experimentalOriented2:b,ignored:y,invisible:A}}},R=[new E(new w.Vector3(0,1,0),new w.Euler(-p.DD/4,0,0),16777215,14540253,1.25),new E(new w.Vector3(-1,0,0),new w.Euler(0,-p.DD/4,0),16750848,8934656,1,{hintDimColor:8930304}),new E(new w.Vector3(0,0,1),new w.Euler(0,0,0),65280,34816,1,{hintDimColor:39168}),new E(new w.Vector3(1,0,0),new w.Euler(0,p.DD/4,0),16711680,6684672,1,{hintDimColor:6684672}),new E(new w.Vector3(0,0,-1),new w.Euler(0,p.DD/2,0),2254591,1127304,.75,{hintDimColor:6246}),new E(new w.Vector3(0,-1,0),new w.Euler(p.DD/4,0,0),16776960,8947712,1.25,{hintDimColor:14540032})],F={U:0,L:1,F:2,R:3,B:4,D:5},C={U:F.U,u:F.U,Uw:F.U,Uv:F.U,y:F.U,L:F.L,l:F.L,Lw:F.L,Lv:F.L,M:F.L,F:F.F,f:F.F,Fw:F.F,Fv:F.F,S:F.F,z:F.F,R:F.R,r:F.R,Rw:F.R,Rv:F.R,x:F.R,B:F.B,b:F.B,Bw:F.B,Bv:F.B,D:F.D,d:F.D,Dw:F.D,Dv:F.D,E:F.D},B=.503,T=1,z=1.45,U={showMainStickers:!0,hintFacelets:"floating",showFoundation:!0,experimentalStickeringMask:void 0,foundationSprite:null,hintSprite:null,initialHintFaceletsAnimation:"auto",faceletScale:"auto"};function G(t){return"undefined"===typeof t.faceletScale||"auto"===t.faceletScale?.85:t.faceletScale}var O=new w.MeshBasicMaterial({color:0,opacity:1,transparent:!0}),P=new w.MeshBasicMaterial({color:0,opacity:.3,transparent:!0}),L=class{constructor(t,e,i){(0,u.A)(this,"matrix",void 0),(0,u.A)(this,"stickerFaces",void 0),this.orbit=t;const s="string"===typeof e?e.split(""):e;this.stickerFaces=s.map((t=>F[t])),this.matrix=new w.Matrix4,this.matrix.setPosition(V[t]),this.matrix.premultiply((new w.Matrix4).makeRotationFromQuaternion(i))}};function N(t,e){return(new w.Quaternion).setFromAxisAngle(t,p.DD*e/4)}var H={O:new w.Vector3(0,0,0),U:new w.Vector3(0,-1,0),L:new w.Vector3(1,0,0),F:new w.Vector3(0,0,-1),R:new w.Vector3(-1,0,0),B:new w.Vector3(0,0,1),D:new w.Vector3(0,1,0)},V={EDGES:new w.Vector3(0,1,1),CORNERS:new w.Vector3(1,1,1),CENTERS:new w.Vector3(0,1,0)},I={EDGES:[0,1].map((t=>(new w.Matrix4).makeRotationAxis(V.EDGES.clone().normalize(),-t*p.DD/2))),CORNERS:[0,1,2].map((t=>(new w.Matrix4).makeRotationAxis(V.CORNERS.clone().normalize(),-t*p.DD/3))),CENTERS:[0,1,2,3].map((t=>(new w.Matrix4).makeRotationAxis(V.CENTERS.clone().normalize(),-t*p.DD/4)))},W=[F.U,F.F,F.R],j={EDGES:[new L("EDGES","UF",N(H.O,0)),new L("EDGES","UR",N(H.U,3)),new L("EDGES","UB",N(H.U,2)),new L("EDGES","UL",N(H.U,1)),new L("EDGES","DF",N(H.F,2)),new L("EDGES","DR",N(H.F,2).premultiply(N(H.D,1))),new L("EDGES","DB",N(H.F,2).premultiply(N(H.D,2))),new L("EDGES","DL",N(H.F,2).premultiply(N(H.D,3))),new L("EDGES","FR",N(H.U,3).premultiply(N(H.R,3))),new L("EDGES","FL",N(H.U,1).premultiply(N(H.R,3))),new L("EDGES","BR",N(H.U,3).premultiply(N(H.R,1))),new L("EDGES","BL",N(H.U,1).premultiply(N(H.R,1)))],CORNERS:[new L("CORNERS","UFR",N(H.O,0)),new L("CORNERS","URB",N(H.U,3)),new L("CORNERS","UBL",N(H.U,2)),new L("CORNERS","ULF",N(H.U,1)),new L("CORNERS","DRF",N(H.F,2).premultiply(N(H.D,1))),new L("CORNERS","DFL",N(H.F,2).premultiply(N(H.D,0))),new L("CORNERS","DLB",N(H.F,2).premultiply(N(H.D,3))),new L("CORNERS","DBR",N(H.F,2).premultiply(N(H.D,2)))],CENTERS:[new L("CENTERS","U",N(H.O,0)),new L("CENTERS","L",N(H.R,3).premultiply(N(H.U,1))),new L("CENTERS","F",N(H.R,3)),new L("CENTERS","R",N(H.R,3).premultiply(N(H.D,1))),new L("CENTERS","B",N(H.R,3).premultiply(N(H.D,2))),new L("CENTERS","D",N(H.R,2))]},q=1/3,J={EDGES:[[[0,4,6],[0,4,5]],[[3,5,7],[0,7,5]],[[2,4,8],[0,10,5]],[[1,3,7],[0,1,5]],[[2,4,2],[2,4,3]],[[3,5,1],[2,7,3]],[[0,4,0],[2,10,3]],[[1,3,1],[2,1,3]],[[3,5,4],[3,6,4]],[[1,3,4],[1,2,4]],[[1,9,4],[1,8,4]],[[3,11,4],[3,0,4]]],CORNERS:[[[0,5,6],[0,5,5],[0,6,5]],[[3,5,8],[0,8,5],[0,9,5]],[[2,3,8],[0,11,5],[0,0,5]],[[1,3,6],[0,2,5],[0,3,5]],[[3,5,2],[2,6,3],[2,5,3]],[[2,3,2],[2,3,3],[2,2,3]],[[1,3,0],[2,0,3],[2,11,3]],[[0,5,0],[2,9,3],[2,8,3]]],CENTERS:[[[0,4,7]],[[0,1,4]],[[0,4,4]],[[0,7,4]],[[0,10,4]],[[0,4,1]]]},Q=null;function Y(){const t=new w.BufferGeometry,e=.5;return t.setAttribute("position",new w.BufferAttribute(new Float32Array([e,e,0,-.5,e,0,e,-.5,0,-.5,e,0,-.5,-.5,0,e,-.5,0]),3)),t.setAttribute("uv",new w.BufferAttribute(new Float32Array([1,1,0,1,1,0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,1,1]),2)),t}var Z=null;var $=(s=new WeakMap,o=new WeakSet,class extends w.Object3D{constructor(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(super(),(0,a.A)(this,o),(0,u.A)(this,"kpuzzleFaceletInfo",void 0),(0,u.A)(this,"pieces",{}),(0,u.A)(this,"options",void 0),(0,u.A)(this,"experimentalHintStickerMeshes",[]),(0,u.A)(this,"experimentalFoundationMeshes",[]),(0,u.A)(this,"setSpriteURL",void 0),(0,u.A)(this,"sprite",new Promise((t=>{this.setSpriteURL=e=>{v.load(e,t)}}))),(0,u.A)(this,"setHintSpriteURL",void 0),(0,u.A)(this,"hintSprite",new Promise((t=>{this.setHintSpriteURL=e=>{v.load(e,t)}}))),(0,l.A)(this,s,null),this.kpuzzle=t,this.scheduleRenderCallback=e,this.options={...U},Object.assign(this.options,i),"3x3x3"!==this.kpuzzle.name())throw new Error("Invalid puzzle for this Cube3D implementation: ".concat(this.kpuzzle.name()));i.foundationSprite&&this.setSprite(i.foundationSprite),i.hintSprite&&this.setHintSprite(i.hintSprite),this.kpuzzleFaceletInfo={};for(const s in j){const t=[];this.kpuzzleFaceletInfo[s]=t,this.pieces[s]=j[s].map(this.createCubie.bind(this,s,t))}this.scale.set(q,q,q),this.options.experimentalStickeringMask&&this.setStickeringMask(this.options.experimentalStickeringMask),(0,d.A)(o,this,K).call(this),this.options.faceletScale&&this.experimentalSetFaceletScale(this.options.faceletScale)}setSprite(t){this.sprite=t}setHintSprite(t){this.hintSprite=t}experimentalSetStickerSpriteURL(t){this.setSpriteURL(t)}experimentalSetHintStickerSpriteURL(t){this.setHintSpriteURL(t)}setStickeringMask(t){if("picture"!==t.specialBehaviour){this.options.experimentalStickeringMask=t;for(const[i,s]of Object.entries(t.orbits))for(let t=0;t<s.pieces.length;t++){const o=s.pieces[t];if(o){const s=this.kpuzzleFaceletInfo[i][t];for(let t=0;t<s.length;t++){const i=o.facelets[t];if(i){var e;const o=s[t],r="string"===typeof i?i:null===i||void 0===i?void 0:i.mask;o.facelet.material=R[o.faceIdx].stickerMaterial[r];const n="string"===typeof i?r:null!==(e=i.hintMask)&&void 0!==e?e:r;o.hintFacelet&&(o.hintFacelet.material=R[o.faceIdx].hintStickerMaterial[n])}}}}this.scheduleRenderCallback&&this.scheduleRenderCallback()}else for(const i of Object.values(this.kpuzzleFaceletInfo))for(const t of i)for(const e of t){e.facelet.material=A;const{hintFacelet:t}=e;t&&(t.material=A)}}experimentalUpdateOptions(t){if("showMainStickers"in t)throw new Error("Unimplemented");const e=t.showFoundation;if("undefined"!==typeof e&&this.options.showFoundation!==e){this.options.showFoundation=e;for(const t of this.experimentalFoundationMeshes)t.visible=e}const i=t.hintFacelets;if("undefined"!==typeof i&&this.options.hintFacelets!==i&&p.yu[i]){this.options.hintFacelets=i;for(const t of this.experimentalHintStickerMeshes)t.visible="floating"===i;this.scheduleRenderCallback()}const{experimentalStickeringMask:s}=t;"undefined"!==typeof s&&(this.options.experimentalStickeringMask=s,this.setStickeringMask(s),this.scheduleRenderCallback());const{faceletScale:o}=t;"undefined"!==typeof o&&this.experimentalSetFaceletScale(o)}onPositionChange(t){const e=t.pattern;for(const i in j){const s=j[i];for(let t=0;t<s.length;t++){const s=e.patternData[i].pieces[t];this.pieces[i][s].matrix.copy(j[i][t].matrix),this.pieces[i][s].matrix.multiply(I[i][e.patternData[i].orientation[t]])}for(const o of t.movesInProgress){const t=o.move,r=R[C[t.family]].vector,n=(new w.Matrix4).makeRotationAxis(r,-this.ease(o.fraction)*o.direction*t.amount*p.DD/4);for(let o=0;o<s.length;o++){const s=this.kpuzzle.moveToTransformation(t.modified({amount:1}));if(o!==s.transformationData[i].permutation[o]||0!==s.transformationData[i].orientationDelta[o]){const t=e.patternData[i].pieces[o];this.pieces[i][t].matrix.premultiply(n)}}}}this.scheduleRenderCallback()}createCubie(t,e,i,s){const o=[];e.push(o);const r=new w.Group;if(this.options.showFoundation){const t=this.createCubieFoundation();r.add(t),this.experimentalFoundationMeshes.push(t)}for(let a=0;a<i.stickerFaces.length;a++){var n;const e=this.createSticker(R[W[a]],R[i.stickerFaces[a]],!1),l={faceIdx:i.stickerFaces[a],facelet:e};if(r.add(e),"floating"===this.options.hintFacelets){const t=this.createSticker(R[W[a]],R[i.stickerFaces[a]],!0);r.add(t),l.hintFacelet=t,this.experimentalHintStickerMeshes.push(t)}if("picture"===(null===(n=this.options.experimentalStickeringMask)||void 0===n?void 0:n.specialBehaviour)&&J[t]&&J[t][s]&&J[t][s][a]){const[e,o,n]=J[t][s][a];(async()=>{const t=async t=>{const s=await(t?this.hintSprite:this.sprite),l=this.createSticker(R[W[a]],R[i.stickerFaces[a]],t);l.material=new w.MeshBasicMaterial({map:s,side:t?w.BackSide:w.DoubleSide,transparent:!0});const c=o/12,h=(o+1)/12,d=n/9,u=(n+1)/9;let p=new w.Vector2(c,d),f=new w.Vector2(c,u),k=new w.Vector2(h,u),m=new w.Vector2(h,d);switch(e){case 1:[p,f,k,m]=[f,k,m,p];break;case 2:[p,f,k,m]=[k,m,p,f];break;case 3:[p,f,k,m]=[m,p,f,k]}l.geometry.setAttribute("uv",new w.BufferAttribute(new Float32Array([k.x,k.y,f.x,f.y,m.x,m.y,f.x,f.y,p.x,p.y,m.x,m.y]),2)),r.add(l)};t(!0),t(!1)})()}o.push(l)}return r.matrix.copy(i.matrix),r.matrixAutoUpdate=!1,this.add(r),r}createCubieFoundation(){var t;const e=function(){var t;return null!==(t=Q)&&void 0!==t?t:Q=new w.BoxGeometry(T,T,T)}();return new w.Mesh(e,"picture"===(null===(t=this.options.experimentalStickeringMask)||void 0===t?void 0:t.specialBehaviour)?O:P)}createSticker(t,e,i){var s,r;const n="picture"===(null===(s=this.options.experimentalStickeringMask)||void 0===s?void 0:s.specialBehaviour)?Y():i?(0,d.A)(o,this,_).call(this):function(){var t;return null!==(t=Z)&&void 0!==t?t:Z=Y()}(),a=new w.Mesh(n,i?e.hintStickerMaterial.regular:e.stickerMaterial.regular);return a.setRotationFromEuler(t.fromZ),a.position.copy(t.vector),a.position.multiplyScalar(i?"picture"===(null===(r=this.options.experimentalStickeringMask)||void 0===r?void 0:r.specialBehaviour)?2:z:B),a.scale.setScalar(G(this.options)),a}experimentalSetFoundationOpacity(t){this.experimentalFoundationMeshes[0].material.opacity=t}experimentalSetFaceletScale(t){this.options.faceletScale=t;for(const i of Object.values(this.kpuzzleFaceletInfo))for(const t of i)for(const i of t){var e;i.facelet.scale.setScalar(G(this.options)),null===(e=i.hintFacelet)||void 0===e||e.scale.setScalar(G(this.options))}}ease(t){return S(t)}});function _(){var t;return null!==(t=(0,h.A)(s,this))&&void 0!==t?t:(0,c.A)(s,this,Y())}function K(){if("none"===this.options.initialHintFaceletsAnimation||"always"!==this.options.initialHintFaceletsAnimation&&(0,p.qC)())return;const t=z-B;(0,d.A)(o,this,_).call(this).translate(0,0,-t),setTimeout((()=>{const e=performance.now();let i=0;const s=()=>{const r=performance.now()-e,n=(a=r/1e3)*(2-a)*t;var a,l;((0,d.A)(o,this,_).call(this).translate(0,0,n-i),i=n,r<1e3)&&(requestAnimationFrame(s),null===(l=this.scheduleRenderCallback)||void 0===l||l.call(this))};s()}),500)}var X=new w.MeshBasicMaterial({side:w.DoubleSide,color:0}),tt=new w.MeshBasicMaterial({visible:!1}),et=new w.MeshBasicMaterial({vertexColors:!0});function it(t,e,i){return Math.hypot(t[3*e]-t[3*i],t[3*e+1]-t[3*i+1],t[3*e+2]-t[3*i+2])}function st(t,e,i,s){const o=it(t,e,i),r=it(t,i,s),n=it(t,e,s),a=(o+r+n)/2;return Math.sqrt(a*(a-o)*(a-r)*(a-n))}function ot(t){let e=0;for(let i=2;3*i<t.length;i++)e+=st(t,0,1,i);return e}function rt(t){const e=function(t,e){const i=new Array(3);return i[0]=t[1]*e[2]-t[2]*e[1],i[1]=t[2]*e[0]-t[0]*e[2],i[2]=t[0]*e[1]-t[1]*e[0],i}([t[3]-t[0],t[4]-t[1],t[5]-t[2]],[t[6]-t[3],t[7]-t[4],t[8]-t[5]]);return function(t){const e=Math.hypot(t[0],t[1],t[2]);return t[0]/=e,t[1]/=e,t[2]/=e,t}(e)}var nt=class{constructor(t,e){(0,u.A)(this,"pos",void 0),(0,u.A)(this,"ipos",void 0),(0,u.A)(this,"vertices",void 0),(0,u.A)(this,"colors",void 0),(0,u.A)(this,"uvs",void 0),(0,u.A)(this,"ind",void 0),this.sz=t,this.tm=e,this.vertices=new Float32Array(9*t),this.uvs=void 0,this.colors=new Uint8Array(18*t),this.ind=new Uint8Array(t),this.pos=0,this.ipos=0}add(t,e,i){this.vertices[this.pos]=t[3*e+0],this.vertices[this.pos+1]=t[3*e+1],this.vertices[this.pos+2]=t[3*e+2],this.colors[this.pos]=i>>16,this.colors[this.pos+1]=i>>8&255,this.colors[this.pos+2]=255&i,this.pos+=3}addUncolored(t,e){this.vertices[this.pos]=t[3*e+0],this.vertices[this.pos+1]=t[3*e+1],this.vertices[this.pos+2]=t[3*e+2],this.pos+=3}setind(t){this.ind[this.ipos++]=t}makePoly(t,e,i){const s=t;for(let o=1;3*(o+1)<s.length;o++)this.add(s,0,e),this.add(s,o,e),this.add(s,o+1,e),this.setind(i)}setAttributes(t){t.setAttribute("position",new w.BufferAttribute(this.vertices,3));const e=this.colors.subarray(0,9*this.sz);t.setAttribute("color",new w.BufferAttribute(e,3,!0))}makeGroups(t){t.clearGroups();for(let e=0;e<this.ipos;){const i=e++,s=this.ind[i];for(;this.ind[e]===s;)e++;t.addGroup(3*i,3*(e-i),s)}}saveOriginalColors(){this.colors.copyWithin(this.pos,0,this.pos)}},at=class{constructor(t,e,i,s){(0,u.A)(this,"origColor",void 0),(0,u.A)(this,"origColorStickeringMask",void 0),(0,u.A)(this,"faceColor",void 0),(0,u.A)(this,"texturePtr",void 0),(0,u.A)(this,"twistVal",-1),(0,u.A)(this,"stickerStart",void 0),(0,u.A)(this,"stickerEnd",void 0),(0,u.A)(this,"hintStart",void 0),(0,u.A)(this,"hintEnd",void 0),(0,u.A)(this,"foundationStart",void 0),(0,u.A)(this,"foundationEnd",void 0),(0,u.A)(this,"isDup",void 0),(0,u.A)(this,"faceNum",void 0),this.isDup=!!e.isDup,this.faceNum=e.face,this.stickerStart=t.ipos;const o=new w.Color(e.color).getHex();this.origColor=o,this.origColorStickeringMask=o,null!==s&&void 0!==s&&s.stickeringMask&&this.setStickeringMask(t,s.stickeringMask),this.faceColor=o;const r=this.stickerCoords(e.coords,i);t.makePoly(r,this.faceColor,this.isDup?4:0),this.stickerEnd=t.ipos}stickerCoords(t,e){return function(t,e){const i=[],s=new Array(3),o=new Array(3);for(let r=1;r<10;r++){for(let n=0;n<t.length;n+=3){const r=(n+t.length-3)%t.length,a=(n+3)%t.length;for(let e=0;e<3;e++)s[e]=t[r+e]-t[n+e],o[e]=t[a+e]-t[n+e];const l=Math.hypot(s[0],s[1],s[2]),c=Math.hypot(o[0],o[1],o[2]);for(let t=0;t<3;t++)s[t]/=l,o[t]/=c;const h=s[0]*o[0]+s[1]*o[1]+s[2]*o[2],d=e/Math.sqrt(1-h*h);for(let e=0;e<3;e++)i[n+e]=t[n+e]+(s[e]+o[e])*d}let r=!0;for(let e=0;r&&e<i.length;e+=3){const s=(e+3)%t.length;let o=0;for(let r=0;r<3;r++)o+=(t[s+r]-t[e+r])*(i[s+r]-i[e+r]);o<=0&&(r=!1)}if(r)return i;e/=2}return t}(t.slice(),e)}hintCoords(t,e,i,s){t=this.stickerCoords(t,i),s=s.slice();for(let r=0;r<3;r++)s[r]*=.5*e;const o=new Array(t.length);for(let r=0;3*r<t.length;r++){const e=t.length/3-1-r;o[3*r]=t[3*e]+s[0],o[3*r+1]=t[3*e+1]+s[1],o[3*r+2]=t[3*e+2]+s[2]}return o}foundationCoords(t){const e=t.slice();for(let i=0;i<t.length;i++)e[i]=.999*t[i];return e}addHint(t,e,i,s,o,r){this.hintStart=t.ipos;const n=this.hintCoords(e.coords,s,o,r);t.makePoly(n,this.faceColor,i&&!this.isDup?2:4),this.hintEnd=t.ipos}addFoundation(t,e,i){this.foundationStart=t.ipos;const s=this.foundationCoords(e.coords);t.makePoly(s,i,this.isDup?4:6),this.foundationEnd=t.ipos}setHintStickers(t,e){const i=this.isDup||!e?4:2;for(let s=this.hintStart;s<this.hintEnd;s++)t.ind[s]=i|1&t.ind[s]}setStickeringMask(t,e){let i=0;switch(e){case"regular":case"invisible":i=this.origColor;break;case"dim":i=16777215===this.origColor?14540253:new w.Color(this.origColor).multiplyScalar(.5).getHex();break;case"oriented":i=16746751;break;case"ignored":i=4473924}this.origColorStickeringMask=i;for(let s=9*this.stickerStart;s<9*this.stickerEnd;s+=3)t.colors[t.pos+s]=i>>16,t.colors[t.pos+s+1]=i>>8&255,t.colors[t.pos+s+2]=255&i;for(let s=9*this.hintStart;s<9*this.hintEnd;s+=3)t.colors[t.pos+s]=i>>16,t.colors[t.pos+s+1]=i>>8&255,t.colors[t.pos+s+2]=255&i;this.setHintStickers(t,"invisible"!==e&&!this.isDup)}addUVs(t){const e=t.uvs,i=t.vertices,s=new Array(3);for(let o=3*this.stickerStart;o<3*this.stickerEnd;o++){s[0]=i[3*o],s[1]=i[3*o+1],s[2]=i[3*o+2];const r=t.tm.getuv(this.faceNum,s);e[2*o]=r[0],e[2*o+1]=r[1]}for(let o=3*this.hintStart;o<3*this.hintEnd;o++){s[0]=i[3*o],s[1]=i[3*o+1],s[2]=i[3*o+2];const r=t.tm.getuv(this.faceNum,s);e[2*o]=r[0],e[2*o+1]=r[1]}}setTexture(t,e){if(this.texturePtr===e)return 0;this.texturePtr=e;const i=6*t.sz;return t.uvs.copyWithin(6*this.stickerStart,6*e.stickerStart+i,6*e.stickerEnd+i),t.uvs.copyWithin(6*this.hintStart,6*e.hintStart+i,6*e.hintEnd+i),1}setColor(t,e){const i=e.origColorStickeringMask;if(this.faceColor!==i){this.faceColor=i;const s=t.pos;return t.colors.copyWithin(9*this.stickerStart,9*e.stickerStart+s,9*e.stickerEnd+s),t.colors.copyWithin(9*this.hintStart,9*e.hintStart+s,9*e.hintEnd+s),1}return 0}},lt=class{constructor(t,e,i){(0,u.A)(this,"cubie",void 0),(0,u.A)(this,"geo",void 0),this.cubie=new w.Group;const s=t.coords,o=new nt(s.length/3-2,e);for(let n=1;3*n+3<s.length;n++)o.addUncolored(s,0),o.addUncolored(s,n),o.addUncolored(s,n+1);this.geo=new w.BufferGeometry,o.setAttributes(this.geo);const r=new w.Mesh(this.geo,tt);r.userData.quantumMove=i.notationMapper.notationToExternal(new m.yU(t.name)),this.cubie.scale.setScalar(.99),this.cubie.add(r)}},ct=class{constructor(t){(0,u.A)(this,"axis",void 0),(0,u.A)(this,"order",void 0);const e=t.coordinates;this.axis=new w.Vector3(e[0],e[1],e[2]),this.order=t.order}},ht=.5,dt=(r=new WeakMap,n=new WeakSet,class extends w.Object3D{constructor(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{};if(super(),(0,a.A)(this,n),(0,u.A)(this,"stickers",void 0),(0,u.A)(this,"axesInfo",void 0),(0,u.A)(this,"stickerTargets",[]),(0,u.A)(this,"controlTargets",[]),(0,u.A)(this,"movingObj",void 0),(0,u.A)(this,"filler",void 0),(0,u.A)(this,"foundationBound",void 0),(0,u.A)(this,"fixedGeo",void 0),(0,u.A)(this,"lastPos",void 0),(0,u.A)(this,"lastMoveTransformation",void 0),(0,u.A)(this,"hintMaterial",void 0),(0,u.A)(this,"stickerMaterial",void 0),(0,u.A)(this,"materialArray1",void 0),(0,u.A)(this,"materialArray2",void 0),(0,u.A)(this,"textured",!1),(0,u.A)(this,"showHintStickers",!1),(0,u.A)(this,"showFoundations",!1),(0,u.A)(this,"hintMaterialDisposable",void 0),(0,u.A)(this,"stickerMaterialDisposable",void 0),(0,l.A)(this,r,!1),(0,u.A)(this,"isPG3DForTwisty3DPuzzleWrapper",void 0),this.scheduleRenderCallback=t,this.kpuzzle=e,this.stickerDat=i,this.faceletScale=h,this.params=d,0===i.stickers.length)throw Error("Reuse of stickerdat from pg; please don't do that.");this.hintMaterial=new w.MeshBasicMaterial({vertexColors:!0,transparent:!0,opacity:.5}),this.hintMaterialDisposable=!0,this.stickerMaterial=et,this.stickerMaterialDisposable=!1,this.axesInfo={};const p=this.stickerDat.axis;for(const r of p)this.axesInfo[r.quantumMove.family]=new ct(r);const f=this.stickerDat.stickers;this.stickers={},this.materialArray1=new Array(8),this.materialArray2=new Array(8),this.showFoundation(s),s=!0;let m=0;for(const r of f){m+=3*(r.coords.length/3-2)}const S=new nt(m,i.textureMapper),v=[];let M=0;for(const r of i.faces)v.push(rt(r.coords)),M+=ot(r.coords);const y="auto"!==h?h*h:.71;let A=0;for(const r of f)r.isDup||A++;const D=Math.sqrt(M/A)*(1-Math.sqrt(y))/2;for(const r of f){const t=r.orbit,e=r.ord,i=r.ori;this.stickers[t]||(this.stickers[t]=[]),this.stickers[t][i]||(this.stickers[t][i]=[]);const s={};d.stickeringMask&&(s.stickeringMask=(0,k.Y)(d.stickeringMask,t,e,i,!1));const o=new at(S,r,D,s);this.stickers[t][i][e]=o}this.showHintStickers=o,o=!0;for(const r of f){const t=r.orbit,e=r.ord,i=r.ori;this.stickers[t][i][e].addHint(S,r,o,c,D,v[r.face])}this.foundationBound=S.ipos;for(const r of f){const t=r.orbit,e=r.ord,i=r.ori;s&&this.stickers[t][i][e].addFoundation(S,r,0)}const g=new w.BufferGeometry;S.setAttributes(g),S.makeGroups(g);const x=new w.Mesh(g,this.materialArray1);x.scale.set(ht,ht,ht),this.add(x);const b=new w.Mesh(g,this.materialArray2);b.scale.set(ht,ht,ht),this.add(b);const E=this.stickerDat.faces;this.movingObj=b,this.fixedGeo=g,this.filler=S;for(const r of E){const t=new lt(r,i.textureMapper,this.stickerDat);t.cubie.scale.set(ht,ht,ht),this.add(t.cubie),this.controlTargets.push(t.cubie.children[0])}S.saveOriginalColors(),i.stickers=[],this.updateMaterialArrays()}dispose(){this.fixedGeo&&this.fixedGeo.dispose(),this.stickerMaterialDisposable&&(this.stickerMaterial.dispose(),this.stickerMaterial=et,this.stickerMaterialDisposable=!1),this.hintMaterialDisposable&&(this.hintMaterial.dispose(),this.hintMaterial=et,this.hintMaterialDisposable=!1)}experimentalGetStickerTargets(){return this.stickerTargets}experimentalGetControlTargets(){return this.controlTargets}getClosestMoveToAxis(t,e){let i=null,s=0,o=t=>t;switch(e.depth){case"secondSlice":o=t=>t.modified({innerLayer:2});break;case"rotation":o=t=>t.modified({family:"".concat(t.family,"v")})}for(const r of this.stickerDat.axis){const e=t.dot(new w.Vector3(...r.coordinates));if(e>s){const t=this.stickerDat.notationMapper.notationToExternal(o(r.quantumMove));if(!t)continue;(0,d.A)(n,this,ut).call(this,t)&&(s=e,i=t)}}if(!i)return null;e.invert&&(i=i.invert());return{move:i,order:this.kpuzzle.moveToTransformation(i).repetitionOrder()}}setStickeringMask(t){if(this.params.stickeringMask=t,"picture"!==t.specialBehaviour)for(const e of this.kpuzzle.definition.orbits){const{numPieces:i,numOrientations:s}=e;for(let o=0;o<i;o++)for(let i=0;i<s;i++){const s=(0,k.Y)(t,e.orbitName,o,i,!1),r=this.stickers[e.orbitName][i][o];this.textured&&this.hintMaterialDisposable&&"invisible"===s||r.setStickeringMask(this.filler,s)}}(0,c.A)(r,this,!0),this.lastPos&&this.onPositionChange(this.lastPos)}onPositionChange(t){const e=t.pattern.experimentalToTransformation();if(!e)throw new Error("indistinguishable pieces are not supported by PG3D yet");const i=new w.Euler;this.movingObj.rotation.copy(i);let s=0;const o=this.filler,n=o.ind;if(!this.lastPos||(0,h.A)(r,this)||!this.lastPos.pattern.experimentalToTransformation().isIdentical(e)){for(const t in this.stickers){const i=this.stickers[t],r=e.transformationData[t],n=i.length;if(1===n){const t=i[0];for(let e=0;e<t.length;e++){const i=r.permutation[e];this.textured?s+=t[e].setTexture(o,t[i]):s+=t[e].setColor(o,t[i])}}else for(let t=0;t<n;t++){const e=i[t];for(let a=0;a<e.length;a++){const l=(t+n-r.orientationDelta[a])%n,c=r.permutation[a];this.textured?s+=e[a].setTexture(o,i[l][c]):s+=e[a].setColor(o,i[l][c])}}}this.lastPos=t}let a=0;for(const r of t.movesInProgress){const t=r.move,e=this.stickerDat.unswizzle(t);if(!e)return;const i=t;let s;try{s=this.kpuzzle.moveToTransformation(i.modified({amount:1}))}catch(l){const t=this.stickerDat.notationMapper.notationToInternal(i);if(t){const e=this.stickerDat.notationMapper.notationToExternal(t.modified({amount:1}));e&&(s=this.kpuzzle.moveToTransformation(e))}if(!s)throw console.log(l),l}const o=this.axesInfo[e.family],c=o.axis,h=-this.ease(r.fraction)*r.direction*e.amount*p.DD/o.order;if(this.movingObj.rotateOnAxis(c,h),this.lastMoveTransformation!==s){for(const t in this.stickers){const e=this.stickers[t],i=e.length,o=s.transformationData[t];for(let t=0;t<i;t++){const i=e[t];for(let t=0;t<i.length;t++){const e=i[t];let s=0;if(o.permutation[t]===t&&0===o.orientationDelta[t]||(s=1),s!==e.twistVal){if(s){for(let t=e.stickerStart;t<e.stickerEnd;t++)n[t]|=1;for(let t=e.hintStart;t<e.hintEnd;t++)n[t]|=1;for(let t=e.foundationStart;t<e.foundationEnd;t++)n[t]|=1}else{for(let t=e.stickerStart;t<e.stickerEnd;t++)n[t]&=-2;for(let t=e.hintStart;t<e.hintEnd;t++)n[t]&=-2;for(let t=e.foundationStart;t<e.foundationEnd;t++)n[t]&=-2}e.twistVal=s,a++}}}}this.lastMoveTransformation=s}}((0,h.A)(r,this)||a)&&this.filler.makeGroups(this.fixedGeo),((0,h.A)(r,this)||s)&&(this.textured&&(this.fixedGeo.getAttribute("uv").addUpdateRange(0,6*this.foundationBound),this.fixedGeo.getAttribute("uv").needsUpdate=!0),!(0,h.A)(r,this)&&this.textured||(this.fixedGeo.getAttribute("color").addUpdateRange(0,9*this.foundationBound),this.fixedGeo.getAttribute("color").needsUpdate=!0)),this.scheduleRenderCallback(),(0,c.A)(r,this,!1)}ease(t){return S(t)}showHintFacelets(t){this.showHintStickers=t}updateMaterialArrays(){for(let t=0;t<8;t++)this.materialArray1[t]=tt,this.materialArray2[t]=tt;this.materialArray1[0]=this.stickerMaterial,this.materialArray2[1]=this.stickerMaterial,this.showHintStickers?(this.materialArray1[2]=this.hintMaterial,this.materialArray2[3]=this.hintMaterial):(this.materialArray1[2]=tt,this.materialArray2[3]=tt),this.showFoundations?(this.materialArray1[6]=X,this.materialArray2[7]=X):(this.materialArray1[6]=tt,this.materialArray2[7]=tt)}showFoundation(t){this.showFoundations=t}setHintStickerOpacity(t){this.hintMaterialDisposable&&(this.hintMaterial.dispose(),this.hintMaterialDisposable=!1),0===t?this.hintMaterial=tt:1===t?this.hintMaterial=this.stickerMaterial:(this.hintMaterial=new w.MeshBasicMaterial({vertexColors:!0,transparent:!0,opacity:t}),this.hintMaterialDisposable=!0)}experimentalUpdateOptions(t){void 0!==t.hintFacelets&&this.showHintFacelets("none"!==t.hintFacelets),void 0!==t.showFoundation&&this.showFoundation(t.showFoundation),void 0!==t.hintStickerOpacity&&this.setHintStickerOpacity(t.hintStickerOpacity),(0,c.A)(r,this,!0),this.lastPos&&this.onPositionChange(this.lastPos),"undefined"!==typeof t.faceletScale&&t.faceletScale!==this.faceletScale&&console.warn("Dynamic facelet scale is not yet supported for PG3D. For now, re-create the TwistyPlayer to change the facelet scale."),this.updateMaterialArrays(),this.scheduleRenderCallback()}adduvs(){const t=this.filler;if(t.uvs)return;this.filler.uvs=new Float32Array(12*t.sz);for(const i in this.stickers){const t=this.stickers[i],e=t.length;for(let i=0;i<e;i++){const e=t[i];for(const t of e)t.addUVs(this.filler)}}t.uvs.copyWithin(6*t.sz,0,6*t.sz);const e=t.uvs.subarray(0,6*t.sz);this.fixedGeo.setAttribute("uv",new w.BufferAttribute(e,2,!0))}experimentalUpdateTexture(t,e,i){e||(t=!1),t&&!this.filler.uvs&&this.adduvs(),this.textured=t,this.stickerMaterialDisposable&&(this.stickerMaterial.dispose(),this.stickerMaterialDisposable=!1),t?(this.stickerMaterial=new w.MeshBasicMaterial({map:e,side:w.FrontSide,transparent:!1}),this.stickerMaterialDisposable=!0):this.stickerMaterial=et,this.hintMaterialDisposable&&(this.hintMaterial.dispose(),this.hintMaterialDisposable=!1),t?(this.hintMaterial=new w.MeshBasicMaterial({map:i,side:w.FrontSide,transparent:!0}),this.hintMaterialDisposable=!0):this.hintMaterial=et,t&&this.showHintFacelets(null!==i),this.updateMaterialArrays(),(0,c.A)(r,this,!0),this.lastPos&&this.onPositionChange(this.lastPos),this.scheduleRenderCallback()}});function ut(t){try{return this.kpuzzle.moveToTransformation(t),!0}catch(e){return!1}}var pt=class{constructor(){(0,u.A)(this,"renderTargets",new Set),(0,u.A)(this,"twisty3Ds",new Set),(0,u.A)(this,"threeJSScene",(async()=>new(await p.u_).Scene)())}addRenderTarget(t){this.renderTargets.add(t)}scheduleRender(){for(const t of this.renderTargets)t.scheduleRender()}async addTwisty3DPuzzle(t){this.twisty3Ds.add(t),(await this.threeJSScene).add(t)}async removeTwisty3DPuzzle(t){this.twisty3Ds.delete(t),(await this.threeJSScene).remove(t)}async clearPuzzles(){for(const t of this.twisty3Ds)(await this.threeJSScene).remove(t);this.twisty3Ds.clear()}};async function ft(t,e){return new $(await f.P$.kpuzzle(),t,e)}async function kt(t,e,i,s,o){return new dt(t,await e.kpuzzle(),(await e.pg()).get3d({darkIgnoredOrbits:o}),!0,"floating"===i,void 0,s)}}}]);
//# sourceMappingURL=158.e8f37d9c.chunk.js.map